<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng mã hóa file</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='mainGUI.css') }}">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Tải lên file của bạn</h1>
        <form action="/encode" method="post" enctype="multipart/form-data" class="mt-4 text-center" id="uploadForm">
            <div class="form-group">
                <input type="file" name="files" class="form-control-file d-none" id="fileInput" multiple>
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click();">
                    <img src="{{ url_for('static', filename='upload-file.png') }}" alt="Upload Icon" class="upload-icon">
                    <p>Kéo & Thả các file của bạn vào đây hoặc ấn để tải lên</p>
                </div>
                <div id="fileDisplay" class="mt-3"></div>
            </div>
            <button type="button" class="btn btn-success btn-block mt-3" onclick="uploadFiles()">Submit</button>
        </form>
        <div id="message" class="mt-3"></div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        let arrFiles = [];
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileDisplay = document.getElementById('fileDisplay');
        const uploadForm = document.getElementById('uploadForm');

        uploadArea.addEventListener('dragover', (event) => {
            event.preventDefault();
            uploadArea.classList.add('dragging');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragging');
        });

        uploadArea.addEventListener('drop', (event) => {
            event.preventDefault();
            uploadArea.classList.remove('dragging');
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                arrFiles.push(...files);
                displayFiles(arrFiles);
            }
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                arrFiles.push(...fileInput.files);
                displayFiles(arrFiles);
            }
        });
        function addFilesToFileInput(files) {
            const dataTransfer = new DataTransfer();
            for (const file of fileInput.files) {
                dataTransfer.items.add(file);
            }
            for (const file of files) {
                dataTransfer.items.add(file);
            }
            fileInput.files = dataTransfer.files;
        }
        function displayFiles(files) {
            fileDisplay.innerHTML = '';
            for (const file of files) {
                const fileElement = document.createElement('div');
                fileElement.classList.add('file-item');
                const fileIcon = document.createElement('img');
                fileIcon.src = '{{ url_for('static', filename='file.png') }}';
                fileIcon.classList.add('file-icon');
                const fileName = document.createElement('p');
                fileName.textContent = file.name;
                fileName.classList.add('file-name');
                const removeButton = document.createElement('button');
                removeButton.textContent = 'Remove';
                removeButton.classList.add('remove-button');
                removeButton.addEventListener('click', () => {
                    fileElement.remove();
                    updateFileInput();
                });
                fileElement.appendChild(fileIcon);
                fileElement.appendChild(fileName);
                fileElement.appendChild(removeButton);
                fileDisplay.appendChild(fileElement);
            }
        }

        function updateFileInput() {
            console.log(arrFiles);
            const dataTransfer = new DataTransfer();
            const fileItems = document.querySelectorAll('.file-item');
            fileItems.forEach(item => {
                const fileName = item.querySelector('.file-name').textContent;
                const file =arrFiles.find(f => f.name === fileName);
                if (file) {
                    dataTransfer.items.add(file);
                }
            });
            arrFiles = Array.from(dataTransfer.files);
        }

        function uploadFiles() {
            const formData = new FormData();
            for (const file of arrFiles) {
                formData.append('files', file);
            }

            fetch('/encode', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                message.textContent = data.message;
                message.classList.add('alert', 'alert-success');
            })
            .catch(error => {
                message.textContent = 'Có lỗi xảy ra khi mã hóa file';
                message.classList.add('alert', 'alert-danger');
            });
        }

        document.addEventListener('dragover', (event) => {
            event.preventDefault();
        });

        document.addEventListener('drop', (event) => {
            event.preventDefault();
        });
    </script>
</body>
</html>